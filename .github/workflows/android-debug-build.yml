name: Android Debug Build

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '.github/**'
      - '!.github/workflows/android-debug-build.yml'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - '**.txt'
  workflow_dispatch:
    inputs:
      build_variant:
        description: 'Build variant'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx6g -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError"
  GRADLE_BUILD_ACTION_CACHE_DEBUG_ENABLED: true

jobs:
  # Job 1: Lint and Static Analysis
  lint:
    name: ðŸ” Lint & Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-read-only: ${{ github.event_name == 'pull_request' }}
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          packages: 'platform-tools,platforms;android-34,build-tools;34.0.0'
      
      - name: Run Detekt
        run: ./gradlew detekt --no-daemon --stacktrace
        continue-on-error: true
      
      - name: Run Ktlint Check
        run: ./gradlew ktlintCheck --no-daemon --stacktrace
        continue-on-error: true
      
      - name: Run Android Lint
        run: ./gradlew lintDebug --no-daemon --stacktrace
      
      - name: Upload Lint Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-reports-${{ github.run_number }}
          path: |
            app/build/reports/lint-results-debug.html
            app/build/reports/detekt/detekt.html
            build/reports/ktlint/
          retention-days: 14
          if-no-files-found: ignore

  # Job 2: Unit Tests
  test:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          packages: 'platform-tools,platforms;android-34,build-tools;34.0.0'
      
      - name: Run Unit Tests
        run: ./gradlew testDebugUnitTest --no-daemon --stacktrace
      
      - name: Generate Test Report
        uses: asadmansr/android-test-report-action@v1.2.0
        if: always()
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_number }}
          path: |
            app/build/test-results/
            app/build/reports/tests/
          retention-days: 14
      
      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports-${{ github.run_number }}
          path: app/build/reports/coverage/
          retention-days: 14
          if-no-files-found: ignore
      
      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: '**/build/test-results/test/TEST-*.xml'
          github_token: ${{ secrets.GITHUB_TOKEN }}
          check_name: 'Unit Test Results'
          fail_on_failure: true

  # Job 3: Build Debug APK
  build:
    name: ðŸ“¦ Build Debug APK
    runs-on: ubuntu-latest
    needs: [lint, test]
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        variant: [debug]
    
    outputs:
      version_code: ${{ steps.version.outputs.VERSION_CODE }}
      version_name: ${{ steps.version.outputs.VERSION_NAME }}
      apk_path: ${{ steps.apk.outputs.APK_PATH }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-read-only: false
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          packages: 'platform-tools,platforms;android-34,build-tools;34.0.0'
      
      - name: Generate Version Info
        id: version
        run: |
          VERSION_CODE=$((10000 + ${{ github.run_number }}))
          VERSION_NAME="2.0.${{ github.run_number }}-debug"
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_ENV
          echo "version_name=$VERSION_NAME" >> $GITHUB_ENV
          echo "âœ… Version: $VERSION_NAME ($VERSION_CODE)"
      
      - name: Inject Version
        run: |
          sed -i "s/versionCode .*/versionCode ${{ env.version_code }}/" app/build.gradle.kts
          sed -i "s/versionName .*/versionName \"${{ env.version_name }}\"/" app/build.gradle.kts
      
      - name: Build Debug APK
        run: |
          ./gradlew assembleDebug \
            --no-daemon \
            --stacktrace \
            -Pandroid.injected.signing.store.file= \
            -Pandroid.injected.signing.store.password= \
            -Pandroid.injected.signing.key.alias= \
            -Pandroid.injected.signing.key.password=
      
      - name: Verify APK
        id: apk
        run: |
          APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
          if [ ! -f "$APK_PATH" ]; then
            echo "âŒ APK not found at $APK_PATH"
            exit 1
          fi
          
          APK_SIZE=$(ls -lh $APK_PATH | awk '{ print $5 }')
          echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
          echo "âœ… APK built successfully: $APK_SIZE"
      
      - name: Analyze APK
        run: |
          ./gradlew app:analyzeDebugBundle --no-daemon || true
      
      - name: Rename APK with Version
        run: |
          mkdir -p artifacts
          cp app/build/outputs/apk/debug/app-debug.apk \
             artifacts/AzKomik-v${{ env.version_name }}.apk
      
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-v${{ env.version_name }}
          path: artifacts/*.apk
          retention-days: 30
          if-no-files-found: error
      
      - name: Upload Build Outputs
        uses: actions/upload-artifact@v4
        with:
          name: build-outputs-${{ matrix.variant }}-${{ github.run_number }}
          path: |
            app/build/outputs/apk/${{ matrix.variant }}/
            app/build/outputs/mapping/${{ matrix.variant }}/
            app/build/reports/
          retention-days: 14
          if-no-files-found: ignore

  # Job 4: Create Release (if on main branch)
  release:
    name: ðŸš€ Create Debug Release
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 10
    permissions:
      contents: write
    
    steps:
      - name: Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-debug-v${{ needs.build.outputs.version_name }}
          path: artifacts
      
      - name: Generate Changelog
        id: changelog
        run: |
          echo "## What's New" > changelog.md
          echo "" >> changelog.md
          git log --oneline --no-merges -20 >> changelog.md || echo "- Build ${{ github.run_number }}" >> changelog.md
          echo "" >> changelog.md
          echo "**Build Info:**" >> changelog.md
          echo "- Version: ${{ needs.build.outputs.version_name }}" >> changelog.md
          echo "- Version Code: ${{ needs.build.outputs.version_code }}" >> changelog.md
          echo "- Commit: ${{ github.sha }}" >> changelog.md
          echo "- Branch: ${{ github.ref_name }}" >> changelog.md
          echo "- Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> changelog.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: debug-v${{ needs.build.outputs.version_name }}
          name: Debug Build v${{ needs.build.outputs.version_name }}
          body_path: changelog.md
          files: artifacts/*.apk
          prerelease: true
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 5: Notify
  notify:
    name: ðŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [build, test, lint]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Build Status
        run: |
          echo "Build: ${{ needs.build.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Lint: ${{ needs.lint.result }}"
