name: Android Release Build

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Version name (leave empty to use tag)'
        required: false
        default: ''
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx8g -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError"

jobs:
  # Job 1: Validate
  validate:
    name: âœ… Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check Secrets
        run: |
          MISSING=""
          if [ -z "${{ secrets.RELEASE_KEYSTORE }}" ]; then
            MISSING="$MISSING RELEASE_KEYSTORE"
          fi
          if [ -z "${{ secrets.RELEASE_KEYSTORE_PASSWORD }}" ]; then
            MISSING="$MISSING RELEASE_KEYSTORE_PASSWORD"
          fi
          if [ -z "${{ secrets.RELEASE_KEY_ALIAS }}" ]; then
            MISSING="$MISSING RELEASE_KEY_ALIAS"
          fi
          if [ -z "${{ secrets.RELEASE_KEY_PASSWORD }}" ]; then
            MISSING="$MISSING RELEASE_KEY_PASSWORD"
          fi
          
          if [ ! -z "$MISSING" ]; then
            echo "âŒ ERROR: Missing required secrets:$MISSING"
            echo "Please add these secrets in Repository Settings > Secrets and Variables > Actions"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"
      
      - name: Validate Version Tag
        if: github.event_name == 'push'
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          if [[ ! $TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "âŒ ERROR: Invalid version tag format: $TAG"
            echo "Expected format: v1.0.0 or v1.0.0-beta"
            exit 1
          fi
          echo "âœ… Version tag validated: $TAG"
      
      - name: Check Branch Protection
        run: |
          echo "âš ï¸ Ensure main branch is protected and requires PR reviews"

  # Job 2: Test and Lint
  quality-gate:
    name: ðŸ” Quality Gate
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          packages: 'platform-tools,platforms;android-34,build-tools;34.0.0'
      
      - name: Run Unit Tests
        run: ./gradlew testReleaseUnitTest --no-daemon --stacktrace
      
      - name: Run Lint
        run: ./gradlew lintRelease --no-daemon --stacktrace

  # Job 3: Build Release
  build:
    name: ðŸ“¦ Build Release
    runs-on: ubuntu-latest
    needs: quality-gate
    timeout-minutes: 30
    permissions:
      contents: write
    
    outputs:
      version_code: ${{ steps.version.outputs.VERSION_CODE }}
      version_name: ${{ steps.version.outputs.VERSION_NAME }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          packages: 'platform-tools,platforms;android-34,build-tools;34.0.0'
      
      - name: Extract Version
        id: version
        run: |
          if [ ! -z "${{ github.event.inputs.version_override }}" ]; then
            VERSION_NAME="${{ github.event.inputs.version_override }}"
          else
            VERSION_NAME=${GITHUB_REF#refs/tags/v}
          fi
          VERSION_CODE=$(echo $VERSION_NAME | sed 's/[^0-9]//g' | cut -c1-8)
          VERSION_CODE=$((VERSION_CODE + 10000))
          
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_ENV
          echo "version_code=$VERSION_CODE" >> $GITHUB_ENV
          
          echo "âœ… Version: $VERSION_NAME ($VERSION_CODE)"
      
      - name: Create Keystore File
        run: |
          mkdir -p app/keystore
          echo "${{ secrets.RELEASE_KEYSTORE }}" | base64 -d > app/keystore/release.jks
          ls -lh app/keystore/release.jks
          echo "âœ… Keystore created"
      
      - name: Create Keystore Properties
        run: |
          cat > keystore.properties << EOF
          storeFile=keystore/release.jks
          storePassword=${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.RELEASE_KEY_ALIAS }}
          keyPassword=${{ secrets.RELEASE_KEY_PASSWORD }}
          EOF
          echo "âœ… Keystore properties created"
      
      - name: Inject Version
        run: |
          sed -i "s/versionCode .*/versionCode ${{ env.version_code }}/" app/build.gradle.kts
          sed -i "s/versionName .*/versionName \"${{ env.version_name }}\"/" app/build.gradle.kts
      
      - name: Build Release APK
        run: |
          ./gradlew assembleRelease \
            --no-daemon \
            --stacktrace \
            -Pandroid.injected.signing.store.file=keystore/release.jks \
            -Pandroid.injected.signing.store.password=${{ secrets.RELEASE_KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.RELEASE_KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.RELEASE_KEY_PASSWORD }}
      
      - name: Build Android App Bundle (AAB)
        run: |
          ./gradlew bundleRelease \
            --no-daemon \
            --stacktrace \
            -Pandroid.injected.signing.store.file=keystore/release.jks \
            -Pandroid.injected.signing.store.password=${{ secrets.RELEASE_KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.RELEASE_KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.RELEASE_KEY_PASSWORD }}
      
      - name: Verify APK Signature
        run: |
          APK_PATH="app/build/outputs/apk/release/app-release.apk"
          if [ ! -f "$APK_PATH" ]; then
            echo "âŒ APK not found"
            exit 1
          fi
          
          # Check if APK is signed
          jarsigner -verify -verbose -certs $APK_PATH | head -20
          
          # Get APK info
          APK_SIZE=$(ls -lh $APK_PATH | awk '{ print $5 }')
          echo "âœ… APK verified: $APK_SIZE"
      
      - name: Analyze APK
        run: |
          ./gradlew app:analyzeReleaseBundle --no-daemon || true
      
      - name: Generate Checksums
        id: checksums
        run: |
          mkdir -p release
          
          # Copy and rename files
          cp app/build/outputs/apk/release/app-release.apk \
             release/AzKomik-v${{ env.version_name }}.apk
          cp app/build/outputs/bundle/release/app-release.aab \
             release/AzKomik-v${{ env.version_name }}.aab
          
          # Generate checksums
          cd release
          sha256sum AzKomik-v${{ env.version_name }}.apk > checksums.txt
          sha256sum AzKomik-v${{ env.version_name }}.aab >> checksums.txt
          cd ..
          
          echo "âœ… Checksums generated"
          cat release/checksums.txt
      
      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-v${{ env.version_name }}
          path: release/
          retention-days: 90
          if-no-files-found: error

  # Job 4: Create GitHub Release
  release:
    name: ðŸš€ Create Release
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-v${{ needs.build.outputs.version_name }}
          path: release
      
      - name: Generate Changelog
        id: changelog
        run: |
          VERSION="${{ needs.build.outputs.version_name }}"
          
          echo "## What's New in v$VERSION" > changelog.md
          echo "" >> changelog.md
          
          # Get changes since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          if [ ! -z "$LAST_TAG" ]; then
            echo "**Changes since $LAST_TAG:**" >> changelog.md
            echo "" >> changelog.md
            git log --pretty=format:"- %s" $LAST_TAG..HEAD --no-merges >> changelog.md
          else
            echo "**Initial Release**" >> changelog.md
          fi
          
          echo "" >> changelog.md
          echo "## Downloads" >> changelog.md
          echo "" >> changelog.md
          echo "| File | Size | Checksum (SHA-256) |" >> changelog.md
          echo "|------|------|-------------------|" >> changelog.md
          
          for file in release/*; do
            if [ -f "$file" ] && [[ "$file" != *".txt" ]]; then
              filename=$(basename "$file")
              size=$(ls -lh "$file" | awk '{ print $5 }')
              checksum=$(sha256sum "$file" | awk '{ print $1 }')
              echo "| $filename | $size | \`${checksum:0:16}...\` |" >> changelog.md
            fi
          done
          
          echo "" >> changelog.md
          echo "## Build Info" >> changelog.md
          echo "- **Version:** v${{ needs.build.outputs.version_name }}" >> changelog.md
          echo "- **Version Code:** ${{ needs.build.outputs.version_code }}" >> changelog.md
          echo "- **Commit:** ${{ github.sha }}" >> changelog.md
          echo "- **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> changelog.md
          
          cat changelog.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.version_name }}
          name: Release v${{ needs.build.outputs.version_name }}
          body_path: changelog.md
          files: release/*
          draft: false
          prerelease: ${{ contains(needs.build.outputs.version_name, '-') }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload to Play Store (Optional)
        if: false  # Enable when Play Store integration is ready
        run: |
          echo "Play Store upload would happen here"
          # Use fastlane or google-play-actions

  # Job 5: Cleanup
  cleanup:
    name: ðŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: release
    if: always()
    steps:
      - name: Delete Keystore
        run: |
          rm -f app/keystore/release.jks || true
          rm -f keystore.properties || true
          echo "âœ… Keystore cleaned up"
