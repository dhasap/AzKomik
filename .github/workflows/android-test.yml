name: Android Test & Quality

on:
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - '**.txt'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/android-test.yml'
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - '**.txt'
      - 'docs/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=512m"

jobs:
  # Job 1: Code Quality
  code-quality:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          packages: 'platform-tools,platforms;android-34,build-tools;34.0.0'
      
      - name: Run Ktlint Check
        run: ./gradlew ktlintCheck --no-daemon
        continue-on-error: true
      
      - name: Run Detekt
        run: ./gradlew detekt --no-daemon
        continue-on-error: true
      
      - name: Upload Code Quality Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-reports-${{ github.run_number }}
          path: |
            build/reports/ktlint/
            app/build/reports/detekt/
          retention-days: 14
          if-no-files-found: ignore

  # Job 2: Unit Tests
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        test-type: [debug, release]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          packages: 'platform-tools,platforms;android-34,build-tools;34.0.0'
      
      - name: Run Unit Tests (${{ matrix.test-type }})
        run: ./gradlew test${{ matrix.test-type }}UnitTest --no-daemon --stacktrace
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results-${{ matrix.test-type }}-${{ github.run_number }}
          path: |
            app/build/test-results/
            app/build/reports/tests/
          retention-days: 14
      
      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: '**/build/test-results/test*/TEST-*.xml'
          check_name: 'Unit Test Results (${{ matrix.test-type }})'
          github_token: ${{ secrets.GITHUB_TOKEN }}
          fail_on_failure: true
          require_tests: true

  # Job 3: Android Lint
  lint:
    name: ðŸ“ Android Lint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          packages: 'platform-tools,platforms;android-34,build-tools;34.0.0'
      
      - name: Run Lint
        run: ./gradlew lintDebug --no-daemon --stacktrace
      
      - name: Upload Lint Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-results-${{ github.run_number }}
          path: |
            app/build/reports/lint-results-debug.html
            app/build/reports/lint-results-debug.xml
          retention-days: 14
      
      - name: Check Lint Results
        run: |
          if [ -f app/build/reports/lint-results-debug.xml ]; then
            ERRORS=$(grep -o 'severity="Error"' app/build/reports/lint-results-debug.xml | wc -l)
            echo "Lint Errors: $ERRORS"
            if [ $ERRORS -gt 0 ]; then
              echo "âŒ Found $ERRORS lint errors"
              exit 1
            fi
          fi

  # Job 4: Build Verification
  build-check:
    name: ðŸ”¨ Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          packages: 'platform-tools,platforms;android-34,build-tools;34.0.0'
      
      - name: Build Debug
        run: ./gradlew assembleDebug --no-daemon --stacktrace
      
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: pr-debug-apk-${{ github.run_number }}
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

  # Job 5: Dependency Check
  dependencies:
    name: ðŸ“¦ Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      
      - name: Check Dependency Updates
        run: ./gradlew dependencyUpdates --no-daemon
        continue-on-error: true
      
      - name: Generate Dependency Report
        run: ./gradlew dependencies --no-daemon > dependencies.txt
      
      - name: Upload Dependencies
        uses: actions/upload-artifact@v4
        with:
          name: dependencies-report-${{ github.run_number }}
          path: dependencies.txt
          retention-days: 7
          if-no-files-found: ignore

  # Job 6: Summary
  summary:
    name: ðŸ“‹ Test Summary
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, lint, build-check]
    if: always()
    
    steps:
      - name: Test Results Summary
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Check | ${{ needs.build-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.unit-tests.result }}" == "success" ] && [ "${{ needs.lint.result }}" == "success" ]; then
            echo "âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some checks failed." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
